#!/usr/bin/env bash
# Configure /etc/hosts so localhost and facebook.com resolve to required IPs

set -euo pipefail

hosts_file="/etc/hosts"
tmp_file="$(mktemp)"
trap 'rm -f "$tmp_file"' EXIT

awk '
BEGIN { localhost_done=0 }
{
  # Drop any existing facebook.com mapping (anywhere in the line)
  for (i = 2; i <= NF; i++) {
    if ($i == "facebook.com") next
  }

  # Only adjust IPv4 loopback lines (avoid touching ::1)
  if ($1 ~ /^127\./) {
    for (i = 2; i <= NF; i++) {
      if ($i == "localhost") {
        $1 = "127.0.0.2"
        localhost_done=1
        break
      }
    }
  }

  print
}
END {
  if (localhost_done == 0) print "127.0.0.2 localhost"
  print "8.8.8.8 facebook.com"
}
' "$hosts_file" > "$tmp_file"

# Overwrite in-place (avoids rename issues with sed -i)
cat "$tmp_file" > "$hosts_file"
